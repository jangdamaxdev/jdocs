---
description: Tìm hiểu cách tích hợp Dataflow vào node editor của bạn với hướng dẫn này. Làm theo từng bước để sử dụng phương pháp Dataflow, cấu hình class node để xử lý dữ liệu đầu vào, và hiểu cách engine giải quyết dữ liệu
keywords: dataflow,data,engine,reset,cache
---

# Dataflow

::alert
Chưa quen với khái niệm Dataflow? Xem bài [Dataflow](/docs/concepts/engine#dataflow) để nắm bắt nhanh
::

::references
:ref-example{title="Dataflow" link="/examples/processing/dataflow"}
:ref-example{title="3D Configurator" link="/examples/3d-configurator"}
:ref-example{title="Allmatter" link="/examples/allmatter"}
:ref-github{title="Plugin" link="https://github.com/retejs/engine"}
::

## Cài đặt dependencies {#install-dependencies}

:kit

```bash
npm i rete rete-engine
```

## Chuẩn bị node {#prepare-nodes}

Hãy xem ví dụ đơn giản về một đồ thị với hai loại node: `NumberNode` và `AddNode`. Các node này chỉ dùng cho xử lý (ví dụ phía server) và không tích hợp với giao diện người dùng. Bạn có thể xem ví dụ đầy đủ có UI ở cuối bài.

```ts
const socket = new ClassicPreset.Socket("socket");

class NumberNode extends ClassicPreset.Node {
  constructor(public value: number) {
    super("Number");
    this.addOutput("value", new ClassicPreset.Output(socket, "Number"));
  }

  data(): { value: number } {
    return { value: this.value };
  }
}

class AddNode extends ClassicPreset.Node {
  constructor() {
    super("Add");
    this.addInput("left", new ClassicPreset.Input(socket, "Left"));
    this.addInput("right", new ClassicPreset.Input(socket, "Right"));
    this.addOutput("value", new ClassicPreset.Output(socket, "Number"));
  }

  data(inputs: { left?: number[]; right?: number[] }): { value: number } {
    const { left, right } = inputs;
    const value = ((left && left[0]) || 0) + ((right && right[0]) || 0);

    return { value };
  }
}

class Connection<
  A extends Node,
  B extends Node
> extends ClassicPreset.Connection<A, B> {}

type Node = NumberNode | AddNode;
type ConnProps = Connection<NumberNode, AddNode> | Connection<AddNode, AddNode>;
type Schemes = GetSchemes<Node, ConnProps>;
```

## Kết nối {#connect}

```ts
import { DataflowEngine } from "rete-engine";
import { NodeEditor } from "rete";

const editor = new NodeEditor<Schemes>();
const engine = new DataflowEngine<Schemes>();

editor.use(engine);
```

## Thêm node và connection {#add-nodes-and-connections}

```ts
const a = new NumberNode(1);
const b = new NumberNode(1);
const sum = new AddNode();

const con1 = new Connection(a, "value", c, "left");
const con2 = new Connection(b, "value", c, "right");

await editor.addNode(a);
await editor.addNode(b);
await editor.addNode(sum);

await editor.addConnection(con1);
await editor.addConnection(con2);
```

## Bắt đầu xử lý {#start-processing}

Lấy dữ liệu output từ node `sum`.

```ts
const result = await engine.fetch(sum.id);
```

Giá trị của `result` sẽ là `{ value: 2 }`, là tổng của các giá trị đầu vào ban đầu của node `sum`.

Nếu bạn muốn thay đổi `a.value` hoặc `b.value`, bạn cần xóa cache trước khi xử lý lại đồ thị. Giá trị output của node được cache để tránh thực thi lặp lại.

```ts
engine.reset(); // reset tất cả node
// hoặc từng node cụ thể
engine.reset(a.id);
engine.reset(b.id);
```

Ngoài ra, phương thức `data` có thể là async. Trong trường hợp này, node `sum` sẽ chờ các phương thức `data` của node đầu vào hoàn thành. Sau khi tất cả trả về giá trị, engine sẽ thực thi phương thức `data` của node `sum`.

Xem kết quả đầy đủ tại ví dụ [Dataflow](/examples/processing/dataflow).
